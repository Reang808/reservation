
{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="{{ tenant.name|escape }} - 予約カレンダー">
    <title>{{ tenant.name|escape }} - 予約カレンダー</title>
    
    <!-- フォント読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- セキュリティヘッダー -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

<style>
    :root {
        --color-background: #f0f2f5;
        --color-white: #ffffff;
        --color-text: #2d3748;
        --color-text-light: #718096;
        --color-primary: #1A365D;
        --color-primary-dark: #112644;
        --color-primary-light: #EBF8FF;
        --color-success: #38A169;
        --color-success-light: #F0FFF4;
        --color-accent-gold: #D69E2E;
        --color-danger: #E53E3E;
        --color-border: #E2E8F0;
        --font-family-base: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.04), 0 1px 2px 0 rgba(0,0,0,0.02);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -1px rgba(0,0,0,0.04);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        --border-radius: 12px;
    }

    body {
        background-color: var(--color-background);
        font-family: var(--font-family-base);
        color: var(--color-text);
        -webkit-text-size-adjust: 100%; /* スマホでの自動文字サイズ調整を無効化 */
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }

    .tenant-info-card {
        background: var(--color-white);
        border: 1px solid var(--color-border);
        border-top: 4px solid var(--color-accent-gold);
        border-radius: var(--border-radius);
        padding: 24px 32px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-md);
    }

    .tenant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* 画面が狭い時に折り返すように */
        gap: 16px;
        padding-bottom: 16px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--color-border);
    }

    .page-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.02em;
        color: var(--color-primary);
    }

    .badge {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .badge-success {
        background-color: var(--color-success-light);
        color: var(--color-success);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 24px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .info-item svg {
        width: 28px;
        height: 28px;
        color: var(--color-primary);
        flex-shrink: 0; /* アイコンが縮まないように */
    }

    .info-label {
        font-size: 0.85rem;
        color: var(--color-text-light);
        margin: 0 0 4px;
    }

    .info-value {
        font-weight: 600;
        color: var(--color-text);
        margin: 0;
    }

    #calendar-container {
        max-width: 1100px;
        margin: 2em auto;
        font-family: var(--font-family-base);
    }

    #calendar-header {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        align-items: center;
        padding: 12px;
        margin-bottom: 32px;
        background: var(--color-white);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    #prev-month {
        justify-self: start; /* 左寄せ */
    }

    #calendar-title {
        justify-self: center; /* センター */
        text-align: center;
    }

    #next-month {
        justify-self: end; /* 右寄せ */
    }

    #calendar-header h2 {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        color: var(--color-primary);
    }

    #calendar-header button {
        background-color: var(--color-primary-light);
        color: var(--color-primary);
        border: 1px solid var(--color-border);
        padding: 10px 16px;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #calendar-header button:hover {
        background-color: var(--color-white);
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    #calendar-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        background-color: var(--color-white);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    #calendar-table th {
        color: var(--color-text-light);
        font-weight: 600;
        padding: 16px 8px;
        font-size: 0.9rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--color-border);
    }

    #calendar-table td {
        height: 120px;
        text-align: left;
        vertical-align: top;
        padding: 8px;
        border: 1px solid var(--color-border);
        transition: all 0.2s;
        position: relative;
    }
    
    .date-cell:not(.disabled) {
        cursor: pointer;
    }
    .date-cell:not(.disabled):hover {
        background-color: var(--color-primary-light);
    }

    .day {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .today .day {
        background-color: var(--color-primary);
        color: var(--color-white);
        border-radius: 50%;
        display: inline-block;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
    }

    .disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }
    .disabled .day {
        color: #adb5bd;
    }

    th.saturday, .saturday .day { color: #007bff; }
    th.sunday, .sunday .day { color: #d9534f; }
    .holiday .day { color: #d9534f; }
    
    .today.sunday .day, .today.saturday .day, .today.holiday .day {
        color: var(--color-white);
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
        background-color: var(--color-white);
        padding: 32px;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--color-border);
        animation: slideIn 0.3s ease-out;
        position: relative;
    }

    #time-slots {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 24px;
    }

    .time-slot {
        background-color: var(--color-white);
        border: 2px solid var(--color-border);
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        color: var(--color-text);
        text-align: center;
    }

    .time-slot.available:hover {
        background-color: var(--color-primary);
        color: var(--color-white);
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .time-slot.unavailable {
        background-color: #f8f9fa;
        color: var(--color-text-light);
        cursor: not-allowed;
        text-decoration: line-through;
        opacity: 0.7;
    }

    /* 予約フォームの共通スタイル */
    .modal-header {
        text-align: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--color-border);
    }
    .modal-header h2, #booking-modal h3 {
        margin: 0;
        color: var(--color-primary);
        font-size: 1.5rem;
        font-weight: 600;
    }
    #booking-modal p {
        margin-top: 8px;
        color: var(--color-text-light);
    }
    .close {
        position: absolute;
        top: 16px;
        right: 16px;
        color: var(--color-text-light);
        font-size: 28px;
        font-weight: 600;
        cursor: pointer;
        line-height: 1;
    }
    .close:hover { color: var(--color-danger); }
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--color-text); font-size: 0.9rem; }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%; padding: 12px 16px; border: 2px solid var(--color-border); border-radius: 8px;
        font-size: 1rem; transition: all 0.2s; background-color: var(--color-white);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light);
    }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--color-border); }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background-color: var(--color-primary); color: var(--color-white); }
    .btn-primary:hover { background-color: var(--color-primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-secondary { background-color: var(--color-text-light); color: var(--color-white); }
    .btn-secondary:hover { background-color: var(--color-text); transform: translateY(-2px); box-shadow: var(--shadow-md); }

    /* アニメーション */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

    /* ========== ここからレスポンシブデザイン ========== */

    /* 768px以下 (タブレットなど) */
    @media (max-width: 768px) {
        .container {
            padding: 0 16px;
        }
        .tenant-info-card {
            padding: 24px 20px;
        }
        .info-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        #calendar-header {
            grid-template-columns: 1fr 2fr 1fr; /* 横並びを維持 */
            gap: 8px;
            padding: 16px;
        }

        #prev-month {
            justify-self: start; /* 左寄せを維持 */
        }

        #calendar-title {
            justify-self: center; /* センターを維持 */
            font-size: 1.2rem; /* タブレット用にサイズ調整 */
        }

        #next-month {
            justify-self: end; /* 右寄せを維持 */
        }
        #calendar-table th {
            font-size: 0.8rem;
            padding: 12px 4px;
        }
        #calendar-table td {
            height: 80px;
            padding: 8px 4px;
        }
        .day {
            font-size: 0.9rem;
        }
        .modal-content {
            width: 95%;
            padding: 24px;
        }
        #time-slots {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .time-slot {
            padding: 10px;
            font-size: 0.9rem;
        }
        .modal-actions {
            flex-direction: column;
            gap: 10px;
        }
        .btn {
            width: 100%;
        }
    }

    /* 480px以下 (スマートフォン - iPhone SE 375px を含む) */
    @media (max-width: 480px) {
        .page-title {
            font-size: 1.4rem;
        }
        .badge {
            font-size: 0.7rem;
            padding: 4px 12px;
        }
        .info-item {
            gap: 12px;
        }
        .info-item svg {
            width: 24px;
            height: 24px;
        }

        #calendar-header {
            grid-template-columns: 1fr 2fr 1fr; /* 横並びを維持 */
            gap: 4px;
            padding: 12px 8px;
        }

        #prev-month {
            justify-self: start;
            padding: 6px 8px;
            font-size: 0.7rem;
        }

        #calendar-title {
            justify-self: center;
            font-size: 0.9rem;
        }

        #next-month {
            justify-self: end;
            padding: 6px 8px;
            font-size: 0.7rem;
        }
        #calendar-table th {
            font-size: 0.7rem;
            padding: 10px 0;
            font-weight: 500;
        }
        #calendar-table td {
            height: 60px;
            padding: 4px;
        }
        .day {
            font-size: 0.8rem;
        }
        .today .day {
            width: 28px;
            height: 28px;
            line-height: 28px;
        }
        .modal-content {
            padding: 24px 16px;
            max-height: 90vh; /* 画面の高さを超えないように */
            overflow-y: auto; /* 内容が多い場合はスクロール */
        }
        .modal-header h2, #booking-modal h3 {
            font-size: 1.25rem;
        }
        #time-slots {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .time-slot {
            font-size: 0.8rem;
            padding: 10px 4px;
        }
        .form-group label {
            font-size: 0.8rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        .btn {
            padding: 12px;
            font-size: 0.9rem;
        }
    }
</style>
</head>
<body>

<div class="container">
    <div class="tenant-info-card">
        <div class="tenant-header">
            <h1 class="page-title">{{ tenant.name|escape }} 予約カレンダー</h1>
            <span class="badge badge-success">✓ SSLで保護されています</span>
        </div>
        <div class="info-grid">
            <div class="info-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <div>
                    <p class="info-label">予約方法</p>
                    <p class="info-value">カレンダーの日付をクリック → 時間を選択 → 予約フォーム入力</p>
                </div>
            </div>
            
            <div class="info-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <div>
                    <p class="info-label">予約確認</p>
                    <p class="info-value">予約完了後、入力されたメールアドレスに確認メールが送信されます</p>
                </div>
            </div>
            <div class="info-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="info-label">キャンセル・変更</p>
                    <p class="info-value">予約の変更・キャンセルはお電話またはメールでご連絡ください。</p>
                </div>
            </div>
        </div>
            
    </div>

    <div id="calendar-container">
        <div id="calendar-header">
            <button id="prev-month">‹ 前月</button>
            <h2 id="calendar-title"></h2>
            <button id="next-month">次月 ›</button>
        </div>
        <table id="calendar-table">
            <thead>
                <tr>
                    <th class="sunday">日</th>
                    <th>月</th>
                    <th>火</th>
                    <th>水</th>
                    <th>木</th>
                    <th>金</th>
                    <th class="saturday">土</th>
                </tr>
            </thead>
            <tbody id="calendar-body">
                </tbody>
        </table>
    </div>
</div>

<div id="booking-modal" class="modal-overlay">
    <div class="modal-content">
        <h3><span id="modal-date"></span> の予約可能時間</h3>
        <p>ご希望の時間を選択してください。</p>
        <div id="time-slots">
            </div>
        <button id="close-modal">閉じる</button>
    </div>
</div>

<div id="reservation-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>予約フォーム</h2>
            <span class="close" onclick="closeReservationModal()">&times;</span>
        </div>
        <form id="reservationForm" method="post" action="{% url 'reserve_slot_by_tenant' tenant.slug %}">
            {% csrf_token %}
            <input type="hidden" name="date" id="reservationDate">
            <input type="hidden" name="time_slot" id="reservationTime">
            
            <div class="form-group">
                <label>予約日時:</label>
                <div id="reservationDateTime" class="info-box"></div>
            </div>
            <div class="form-group">
                <label for="menu_id">メニュー選択:</label>
                <select name="menu_id" id="menu_id" class="form-select" required>
                    <option value="">メニューを選択してください</option>
                    {% for menu in tenant.menus.all %}
                        <option value="{{ menu.id }}">
                            {{ menu.name|escape }}
                            {% if menu.price %} - ¥{{ menu.price|floatformat:0 }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="customer_name">お名前:</label>
                <input type="text" name="customer_name" id="customer_name" class="form-input" required placeholder="例：山田 花子" autocomplete="name">
            </div>
            <div class="form-group">
                <label for="customer_email">メールアドレス:</label>
                <input type="email" name="customer_email" id="customer_email" class="form-input" required placeholder="例：yamada@example.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label for="customer_phone">電話番号:</label>
                <input type="tel" name="customer_phone" id="customer_phone" class="form-input" required placeholder="例：09012345678" autocomplete="tel">
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeReservationModal()" class="btn btn-secondary">キャンセル</button>
                <button type="submit" class="btn btn-primary">この内容で予約する</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 要素の取得 ---
    const calendarTitle = document.getElementById('calendar-title');
    const calendarBody = document.getElementById('calendar-body');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const bookingModal = document.getElementById('booking-modal');
    const modalDate = document.getElementById('modal-date');
    const timeSlotsContainer = document.getElementById('time-slots');
    const closeModalBtn = document.getElementById('close-modal');

    // --- 初期設定 ---
    const today = new Date();
    today.setHours(0, 0, 0, 0); // 時刻をリセットして日付のみで比較
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth(); // 0-11 (1月が0)

    // --- テナント情報の取得 ---
    const tenantData = {
        slug: '{{ tenant.slug }}',
        name: '{{ tenant.name|escape }}',
        startTime: '{{ tenant.start_time|time:"H:i" }}',
        endTime: '{{ tenant.end_time|time:"H:i" }}',
        slotDuration: {{ tenant.slot_duration }},
        openDays: {
            monday: {{ tenant.monday_open|yesno:"true,false" }},
            tuesday: {{ tenant.tuesday_open|yesno:"true,false" }},
            wednesday: {{ tenant.wednesday_open|yesno:"true,false" }},
            thursday: {{ tenant.thursday_open|yesno:"true,false" }},
            friday: {{ tenant.friday_open|yesno:"true,false" }},
            saturday: {{ tenant.saturday_open|yesno:"true,false" }},
            sunday: {{ tenant.sunday_open|yesno:"true,false" }}
        }
    };

    // --- 祝日リスト（手動で定義） ---
    const holidays = [
        '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-03-20',
        '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06',
        '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13',
        '2025-11-03', '2025-11-23', '2025-12-23'
    ];

    /**
     * 営業日判定関数
     * @param {Date} date - 判定する日付
     * @returns {boolean} - 営業日かどうか
     */
    function isOpenDay(date) {
        const dayOfWeek = date.getDay(); // 0=日曜, 1=月曜, ..., 6=土曜
        const openDaysArray = [
            tenantData.openDays.sunday,
            tenantData.openDays.monday,
            tenantData.openDays.tuesday,
            tenantData.openDays.wednesday,
            tenantData.openDays.thursday,
            tenantData.openDays.friday,
            tenantData.openDays.saturday
        ];
        return openDaysArray[dayOfWeek];
    }

    /**
     * カレンダーを生成して表示する関数
     * @param {number} year - 年
     * @param {number} month - 月 (0-11)
     */
    function renderCalendar(year, month) {
        // カレンダーのタイトルを更新
        calendarTitle.textContent = `${year}年 ${month + 1}月`;
        calendarBody.innerHTML = ''; // 中身をリセット

        // 月の初日と最終日を取得
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let date = 1;
        for (let i = 0; i < 6; i++) { // 最大6週間
            const row = document.createElement('tr');
            
            for (let j = 0; j < 7; j++) { // 曜日（日〜土）
                const cell = document.createElement('td');

                if (i === 0 && j < firstDay.getDay()) {
                    // 月の始まる前の空セル
                    cell.classList.add('disabled');
                } else if (date > lastDay.getDate()) {
                    // 月の終わった後の空セル
                    cell.classList.add('disabled');
                } else {
                    // 日付セル
                    const currentDate = new Date(year, month, date);
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    
                    cell.innerHTML = `<div class="day">${date}</div>`;
                    cell.dataset.date = dateStr;
                    cell.classList.add('date-cell');

                    // --- クラスの追加 ---
                    // 過去の日付や営業日でない日は無効に
                    if (currentDate < today || !isOpenDay(currentDate)) {
                        cell.classList.add('disabled');
                    }
                    // 土日祝日の判定
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek === 0) cell.classList.add('sunday');
                    if (dayOfWeek === 6) cell.classList.add('saturday');
                    if (holidays.includes(dateStr)) cell.classList.add('holiday');
                    
                    // 今日の日付をハイライト
                    if (currentDate.getTime() === today.getTime()) {
                        cell.classList.add('today');
                    }

                    date++;
                }
                row.appendChild(cell);
            }
            calendarBody.appendChild(row);
            if (date > lastDay.getDate()) break; // 月の最終日を超えたらループを抜ける
        }
    }
    
    /**
     * 指定された日付の予約可能時間を表示する関数
     * @param {string} dateStr - 'YYYY-MM-DD'形式の日付文字列
     */
    async function showBookingTimes(dateStr) {
        modalDate.textContent = dateStr;
        timeSlotsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">読み込み中...</div>';

        try {
            // サーバーから予約状況を取得
            const response = await fetch(`/tenant/${tenantData.slug}/api/slots/?date=${dateStr}`);
            if (!response.ok) {
                throw new Error('予約情報の取得に失敗しました');
            }
            
            const data = await response.json();
            timeSlotsContainer.innerHTML = ''; // 中身をリセット

            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const timeSlot = document.createElement('div');
                    timeSlot.textContent = slot.time;
                    timeSlot.classList.add('time-slot');
                    
                    if (slot.is_reserved) {
                        timeSlot.classList.add('unavailable');
                    } else if (slot.is_available) {
                        timeSlot.classList.add('available');
                        timeSlot.dataset.datetime = `${dateStr} ${slot.time}`;
                    } else {
                        timeSlot.classList.add('unavailable');
                    }
                    timeSlotsContainer.appendChild(timeSlot);
                });
            } else {
                timeSlotsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">この日は予約枠がありません</div>';
            }
        } catch (error) {
            console.error('Error fetching slots:', error);
            timeSlotsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">エラーが発生しました</div>';
        }

        bookingModal.style.display = 'flex'; // モーダルを表示
    }


    // --- イベントリスナー ---

    // 前月ボタン
    prevMonthBtn.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
    });

    // 次月ボタン
    nextMonthBtn.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
    });

    // 日付セルクリック（イベント委任）
    calendarBody.addEventListener('click', (e) => {
        const cell = e.target.closest('.date-cell');
        if (cell && !cell.classList.contains('disabled')) {
            const dateStr = cell.dataset.date;
            showBookingTimes(dateStr);
        }
    });

    // モーダルを閉じる
    closeModalBtn.addEventListener('click', () => {
        bookingModal.style.display = 'none';
    });
    // モーダルの背景クリックで閉じる
    bookingModal.addEventListener('click', (e) => {
        if (e.target === bookingModal) {
            bookingModal.style.display = 'none';
        }
    });

    // 時間帯クリック
    timeSlotsContainer.addEventListener('click', (e) => {
        const slot = e.target.closest('.time-slot.available');
        if (slot) {
            const selectedDateTime = slot.dataset.datetime;
            const [date, time] = selectedDateTime.split(' ');
            
            // 時間選択モーダルを閉じる
            bookingModal.style.display = 'none';
            
            // 予約フォームモーダルを開く
            openReservationModal(date, time);
        }
    });

    // 予約フォームモーダル関連の関数
    const reservationModal = document.getElementById('reservation-modal');
    const reservationForm = document.getElementById('reservationForm');

    window.openReservationModal = function(date, time) {
        document.getElementById('reservationDate').value = date;
        document.getElementById('reservationTime').value = time;
        
        const dateObj = new Date(date + 'T' + time);
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' };
        document.getElementById('reservationDateTime').textContent = dateObj.toLocaleDateString('ja-JP', options);
        
        reservationModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    window.closeReservationModal = function() {
        reservationModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    };

    // 予約フォーム送信処理
    reservationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn.disabled) return;
        
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '予約処理中...';

        const formData = new FormData(this);
        const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (ok) {
                alert('予約が完了しました！');
                window.location.reload();
            } else {
                alert('予約に失敗しました: ' + (data.message || '不明なエラー'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('予約処理でエラーが発生しました');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });

    // --- 初期表示 ---
    renderCalendar(currentYear, currentMonth);
});

</script>

</body>
</html>
