{% extends 'base.html' %}
{% block content %}
<div class="container owner-management-page">
    <div class="header">
        <h1>{{ tenant.name }} 予約管理</h1>
        <div class="button-group">
            <a href="{% url 'owner_menu_list_by_tenant' tenant.slug %}" class="btn btn-primary">メニュー管理</a>
             <a href="{% url 'owner_email_settings' tenant.slug %}" class="btn btn-primary">メール設定</a>
            {# このページのURLなのでボタンは非表示にするか、別のページへのリンクにします #}
            {# <a href="{% url 'owner_reserve_list_by_tenant' tenant.slug %}" class="btn btn-primary">予約カレンダー</a> #}
        </div>
    </div>
    <div class="main-content">
        <div class="card calendar-card">
            <div class="calendar-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
                <form method="get" style="margin:0;">
                    <input type="hidden" name="week_offset" value="{{ week_offset|add:'-1' }}">
                    <button type="submit" class="btn btn-secondary btn-sm">← 前週</button>
                </form>
                <h2 style="margin:0;flex:1;text-align:center;min-width:120px;">予約カレンダー</h2>
                <form method="get" style="margin:0;">
                    <input type="hidden" name="week_offset" value="{{ week_offset|add:'1' }}">
                    <button type="submit" class="btn btn-secondary btn-sm">次週 →</button>
                </form>
            </div>
            
            <div class="desktop-calendar">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="time-header">時間</th>
                                {% for day in week_days %}
                                <th class="day-header">{{ day|date:'m/d' }}<br><span class="day-of-week">{{ day|date:'D' }}</span></th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in calendar_rows %}
                            <tr>
                                <td class="time-header">{{ row.0.slot|time:'H:i' }}</td>
                                {% for cell in row %}
                                <td class="calendar-cell">
                                    {% if cell.reservation %}
                                    <div class="reserved-slot">
                                        <span class="customer-name">{{ cell.reservation.customer_name|escape }}</span>
                                        <form method="post" action="{% url 'owner_reserve_delete' cell.reservation.id %}" class="delete-form">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('本当に削除しますか？');">削除</button>
                                        </form>
                                    </div>
                                    {% else %}
                                    <button class="btn btn-success btn-sm" onclick="showAddForm('{{ cell.day|date:'Y-m-d' }}','{{ cell.slot|time:'H:i' }}')">＋</button>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mobile-calendar">
                <div class="date-selector">
                    {% for day in week_days %}
                    <div class="date-chip {% if forloop.first %}active{% endif %}" data-day-index="{{ forloop.counter0 }}">
                        <span class="chip-day">{{ day|date:"D" }}</span>
                        <span class="chip-date">{{ day|date:"j" }}</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="calendar-panels">
                    {% for day in week_days %}
                    <div class="calendar-day-panel {% if forloop.first %}active{% endif %}" data-day-index="{{ forloop.counter0 }}">
                        <ul class="slot-list">
                            {% for row in calendar_rows %}
                                {% for cell in row %}
                                    {% if forloop.counter0 == forloop.parentloop.parentloop.counter0 %}
                                    <li class="slot-item">
                                        <div class="slot-time">{{ cell.slot|time:"H:i" }}</div>
                                        <div class="slot-status">
                                            {% if cell.reservation %}
                                                <div class="reserved-info">
                                                    <span class="customer-name">{{ cell.reservation.customer_name|escape }}</span>
                                                    <form method="post" action="{% url 'owner_reserve_delete' cell.reservation.id %}" class="delete-form">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('本当にこの予約を削除しますか？');">削除</button>
                                                    </form>
                                                </div>
                                            {% else %}
                                                <button type="button" class="btn btn-success" onclick="showAddForm('{{ cell.day|date:'Y-m-d' }}','{{ cell.slot|time:'H:i' }}')">追加</button>
                                            {% endif %}
                                        </div>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card list-card">
            <h2>予約一覧</h2>

            <!-- PC/タブレット: テーブル表示 -->
            <div class="table-container reservation-table">
                <table>
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>時間</th>
                            <th>メニュー</th>
                            <th>顧客名</th>
                            <th>メールアドレス</th>
                            <th>電話番号</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in reservations %}
                        <tr>
                            <td>{{ r.date|date:"m/d" }}</td>
                            <td>{{ r.time_slot|time:"H:i" }}</td>
                            <td>{% if r.menu %}{{ r.menu.name|escape }}{% endif %}</td>
                            <td>{{ r.customer_name|escape }}</td>
                            <td>{{ r.customer_email|default:'-'|escape }}</td>
                            <td>{{ r.customer_phone|escape }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="no-data">予約はありません</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- スマホ: カード型リスト表示 -->
            <div class="reservation-cards">
                {% for r in reservations %}
                <div class="reservation-card">
                    <div class="rc-row rc-date"><span class="rc-label">日付</span><span class="rc-value">{{ r.date|date:"m/d" }}</span></div>
                    <div class="rc-row rc-time"><span class="rc-label">時間</span><span class="rc-value">{{ r.time_slot|time:"H:i" }}</span></div>
                    <div class="rc-row rc-menu"><span class="rc-label">メニュー</span><span class="rc-value">{% if r.menu %}{{ r.menu.name|escape }}{% endif %}</span></div>
                    <div class="rc-row rc-customer"><span class="rc-label">顧客名</span><span class="rc-value">{{ r.customer_name|escape }}</span></div>
                    <div class="rc-row rc-email"><span class="rc-label">メール</span><span class="rc-value">{{ r.customer_email|default:'-'|escape }}</span></div>
                    <div class="rc-row rc-phone"><span class="rc-label">電話</span><span class="rc-value">{{ r.customer_phone|escape }}</span></div>
                </div>
                {% empty %}
                <div class="no-data">予約はありません</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="add-form-modal" class="modal">
    <div class="modal-content">
        <form method="post" id="add-reserve-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="date" id="add-date">
            <input type="hidden" name="time_slot" id="add-time-slot">
            <div class="modal-header">
                <h3>予約追加</h3>
                <span class="modal-date-time"><b id="add-date-label"></b> <b id="add-time-label"></b></span>
            </div>
            <div class="form-group">
                <label for="menu">メニュー:</label>
                <select id="menu" name="menu_id" class="form-control">
                    {% for m in menus %}<option value="{{ m.id }}">{{ m.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="customer_name">顧客名:</label>
                <input type="text" id="customer_name" name="customer_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="customer_email">メールアドレス:</label>
                <input type="email" id="customer_email" name="customer_email" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="customer_phone">電話番号:</label>
                <input type="tel" id="customer_phone" name="customer_phone" class="form-control" required>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">予約追加</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddForm()">キャンセル</button>
            </div>
        </form>
    </div>
</div>

<style>
    :root {
        --color-background: #f0f2f5;
        --color-white: #ffffff;
        --color-text: #2d3748;
        --color-text-light: #718096;
        --color-primary: #1A365D;
        --color-primary-dark: #112644;
        --color-primary-light: #EBF8FF;
        --color-success: #38A169;
        --color-success-light: #F0FFF4;
        --color-accent-gold: #D69E2E;
        --color-danger: #E53E3E;
        --color-border: #E2E8F0;
        --font-family-base: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.04), 0 1px 2px 0 rgba(0,0,0,0.02);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -1px rgba(0,0,0,0.04);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        --border-radius: 12px;
    }

    body {
        background-color: var(--color-background);
        font-family: var(--font-family-base);
        color: var(--color-text);
    }
    .container {
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 15px;
    }
    .header {
        text-align: center;
        margin-bottom: 24px;
    }
    .header h1 {
        font-size: 1.8rem;
        color: var(--color-primary);
        margin-bottom: 1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
    }
    .button-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    .main-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .calendar-card, .list-card {
        width: 100%;
        min-width: 0;
    }
    .card {
        background: var(--color-white);
        padding: 28px 24px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
    }
    .card h2 {
        font-size: 1.3rem;
        margin: 0 0 20px 0;
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 10px;
        color: var(--color-primary);
    }
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }
    .btn-primary {
        background-color: var(--color-primary);
        color: var(--color-white);
    }
    .btn-primary:hover {
        background-color: var(--color-primary-dark);
        transform: translateY(-2px);
    }
    .btn-success {
        background-color: var(--color-success);
        color: var(--color-white);
    }
    .btn-success:hover {
        background-color: #258a4a;
        transform: translateY(-2px);
    }
    .btn-danger {
        background-color: var(--color-danger);
        color: var(--color-white);
    }
    .btn-danger:hover {
        background-color: #a91d1d;
    }
    .btn-secondary {
        background-color: var(--color-primary-light);
        color: var(--color-primary);
        border: 1px solid var(--color-border);
    }
    .btn-secondary:hover {
        background-color: var(--color-white);
        color: var(--color-primary);
        border-color: var(--color-primary);
    }
    .btn-sm {
        padding: 4px 10px;
        font-size: 0.9em;
    }
    .table-container {
        overflow-x: auto;
        width: 100%;
    }
    table {
        width: 100%;
        min-width: 480px;
        border-collapse: collapse;
        background: var(--color-white);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        overflow: hidden;
    }
    th, td {
        padding: 14px 10px;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
        word-break: break-word;
    }
    th {
        background-color: #f7fafc;
        font-weight: 600;
        color: var(--color-text-light);
        white-space: nowrap;
        font-size: 0.98em;
    }
    .no-data {
        text-align: center;
        color: #999;
        padding: 20px;
    }
    .desktop-calendar { display: block; }
    .day-header { text-align: center; }
    .day-of-week { font-size: 0.8em; color: var(--color-text-light); }
    .time-header { font-weight: 600; text-align: center; }
    .calendar-cell { text-align: center; vertical-align: middle; }
    .reserved-slot {
        background-color: #fff5f5;
        border-radius: 8px;
        padding: 7px 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        border: 1px solid #ffe0e0;
    }
    .customer-name {
        font-weight: 600;
        font-size: 0.98em;
        color: var(--color-danger);
    }
    .delete-form { margin: 0; }
    .mobile-calendar { display: none; }
    .date-selector {
        display: flex;
        justify-content: space-around;
        gap: 6px;
        margin-bottom: 20px;
    }
    .date-chip {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
        padding: 8px 4px;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--color-white);
    }
    .date-chip:hover {
        background-color: var(--color-primary-light);
    }
    .date-chip.active {
        background-color: var(--color-primary);
        color: var(--color-white);
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    .date-chip .chip-day { font-size: 0.75rem; }
    .date-chip .chip-date { font-size: 1rem; font-weight: 500; margin-top: 2px; }
    .date-chip.active .chip-day, .date-chip.active .chip-date { color: var(--color-white); }
    .calendar-day-panel { display: none; }
    .calendar-day-panel.active { display: block; }
    .slot-list { list-style: none; padding: 0; margin: 0; }
    .slot-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--color-border);
    }
    .slot-item:last-child { border-bottom: none; }
    .slot-time { font-weight: 600; width: 70px; flex-shrink: 0; }
    .slot-status { flex-grow: 1; }
    .reserved-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .reservation-cards {
        display: none;
        gap: 12px;
        flex-direction: column;
        margin-top: 8px;
    }
    .reservation-card {
        background: var(--color-success-light);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        padding: 12px 14px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border: 1px solid var(--color-success);
    }
    .rc-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1em;
        padding: 2px 0;
    }
    .rc-label {
        color: var(--color-text-light);
        font-size: 0.97em;
        min-width: 60px;
    }
    .rc-value {
        font-weight: 600;
        color: var(--color-text);
        text-align: right;
    }
    .modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
    }
    .modal.is-visible { opacity: 1; visibility: visible; }
    .modal-content {
        background-color: var(--color-white);
        padding: 28px 24px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        width: 90vw;
        max-width: 420px;
        min-width: 200px;
        margin: 0 auto;
        transform: translateY(-20px);
        transition: transform 0.3s;
    }
    .modal.is-visible .modal-content { transform: translateY(0); }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .modal-header h3 {
        font-size: 1.2rem;
        margin: 0;
        color: var(--color-primary);
    }
    .modal-date-time {
        font-weight: 600;
        color: var(--color-text-light);
        font-size: 0.95em;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.95em;
        color: var(--color-text-light);
    }
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1em;
        background: var(--color-white);
        color: var(--color-text);
        transition: all 0.2s;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
    }
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    select.form-control { min-width: 150px; }
    @media (max-width: 992px) {
        .main-content { gap: 0; }
        .card { flex-basis: auto; width: 100%; min-width: 0; }
    }
    @media (max-width: 768px) {
        .desktop-calendar { display: none; }
        .mobile-calendar { display: block; }
        .header h1 { font-size: 1.5rem; }
        .card { padding: 10px; }
        .card h2 { font-size: 1.1rem; }
        .btn { font-size: 0.9em; padding: 8px 12px; }
        .list-card .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -10px;
        }
        .list-card table {
            min-width: 400px;
            font-size: 0.95em;
        }
        th, td {
            padding: 8px 6px;
            font-size: 0.95em;
        }
    }
    @media (max-width: 480px) {
        .header h1 { font-size: 1.1rem; }
        .button-group { flex-direction: column; gap: 8px; }
        .btn { width: 100%; }
        .card { padding: 6px; }
        .list-card .reservation-table { display: none; }
        .reservation-cards { display: flex; }
        .list-card .table-container { margin: 0; }
    }
</style>

<script>
// --- モーダル表示/非表示 ---
function showAddForm(date, time) {
    document.getElementById('add-date').value = date;
    document.getElementById('add-time-slot').value = time;
    document.getElementById('add-date-label').innerText = date;
    document.getElementById('add-time-label').innerText = time;
    document.getElementById('add-form-modal').classList.add('is-visible');
}
function hideAddForm() {
    document.getElementById('add-form-modal').classList.remove('is-visible');
}

document.addEventListener('DOMContentLoaded', function() {
    // --- モバイル用 日付チップ切り替え ---
    const dateChips = document.querySelectorAll('.date-chip');
    const panels = document.querySelectorAll('.calendar-day-panel');
    if(dateChips.length > 0) {
        dateChips.forEach(chip => {
            chip.addEventListener('click', () => {
                const dayIndex = chip.getAttribute('data-day-index');
                dateChips.forEach(c => c.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));
                chip.classList.add('active');
                const activePanel = document.querySelector(`.calendar-day-panel[data-day-index="${dayIndex}"]`);
                if (activePanel) {
                    activePanel.classList.add('active');
                }
            });
        });
    }

    // --- モーダルの外側クリックで閉じる ---
    const modal = document.getElementById('add-form-modal');
    if(modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === this) {
                hideAddForm();
            }
        });
    }
});
</script>
{% endblock %}