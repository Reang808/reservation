{% extends 'base.html' %}
{% block content %}
<div class="container owner-calendar-page">
    <div class="header">
        <h1>{{ tenant.name }} 予約カレンダー</h1>
        <p class="back-link"><a href="{% url 'owner_reserve_list' %}" class="btn btn-secondary">予約一覧に戻る</a></p>
    </div>

    <div class="card form-card">
        <h2><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> 予約の追加</h2>
        <form method="post" class="reserve-form">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="date_input">日付:</label>
                    <input type="date" name="date" id="date_input" required>
                </div>
                <div class="form-group">
                    <label for="time_slot_select">時間:</label>
                    <select name="time_slot" id="time_slot_select">
                        {% for slot in time_slots %}
                        <option value="{{ slot|time:'H:i' }}">{{ slot|time:'H:i' }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="menu_select">メニュー:</label>
                    <select name="menu_id" id="menu_select">
                        {% for m in menus %}
                        <option value="{{ m.id }}">{{ m.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="customer_name_input">顧客名:</label>
                    <input type="text" name="customer_name" id="customer_name_input" required placeholder="例：山田 花子">
                </div>
                <div class="form-group full-width">
                    <label for="customer_phone_input">電話番号:</label>
                    <input type="tel" name="customer_phone" id="customer_phone_input" required maxlength="20" placeholder="例：09012345678">
                </div>
            </div>
            <div class="form-submit">
                <button type="submit" class="btn btn-primary">予約を追加する</button>
            </div>
        </form>
    </div>

    <div class="card calendar-wrapper">
        <h2><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg> 予約カレンダー</h2>

        <div class="desktop-calendar">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="time-header">時間</th>
                            {% for day in week_days %}
                            <th class="day-header">
                                <span class="day-of-week">{{ day|date:"D" }}</span>
                                <span class="date">{{ day|date:"n/j" }}</span>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in calendar_rows %}
                        <tr>
                            <td class="time-header">{{ row.0.slot|time:'H:i' }}</td>
                            {% for cell in row %}
                            <td class="calendar-cell">
                                {% if cell.reservation %}
                                    <div class="reserved-slot">
                                        <span class="customer-name">{{ cell.reservation.customer_name|escape }}</span>
                                        <form method="post" action="{% url 'owner_reserve_delete' cell.reservation.id %}" class="delete-form">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('本当にこの予約を削除しますか？');">削除</button>
                                        </form>
                                    </div>
                                {% else %}
                                    <span class="available-text">空き</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mobile-calendar">
            <div class="date-selector">
                {% for day in week_days %}
                <div class="date-chip {% if forloop.first %}active{% endif %}" data-day-index="{{ forloop.counter0 }}">
                    <span class="chip-day">{{ day|date:"D" }}</span>
                    <span class="chip-date">{{ day|date:"j" }}</span>
                </div>
                {% endfor %}
            </div>

            <div class="calendar-panels">
                {% for day in week_days %}
                <div class="calendar-day-panel {% if forloop.first %}active{% endif %}" data-day-index="{{ forloop.counter0 }}">
                    <ul class="slot-list">
                        {% for row in calendar_rows %}
                            {% for cell in row %}
                                {% if forloop.counter0 == forloop.parentloop.parentloop.counter0 %}
                                <li class="slot-item">
                                    <div class="slot-time">{{ cell.slot|time:"H:i" }}</div>
                                    <div class="slot-status">
                                        {% if cell.reservation %}
                                            <div class="reserved-info">
                                                <span class="customer-name">{{ cell.reservation.customer_name|escape }}</span>
                                                <form method="post" action="{% url 'owner_reserve_delete' cell.reservation.id %}" class="delete-form">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('本当にこの予約を削除しますか？');">削除</button>
                                                </form>
                                            </div>
                                        {% else %}
                                            <span class="available-text">空き</span>
                                        {% endif %}
                                    </div>
                                </li>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --color-primary: #8E7CC3;
    --color-primary-dark: #7A69A9;
    --color-danger: #FF6B6B;
    --color-danger-dark: #E65A5A;
    --color-background: #F8F9FA;
    --color-surface: #FFFFFF;
    --color-border: #E0E0E0;
    --color-text: #333333;
    --color-text-light: #757575;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --border-radius: 12px;
}

body {
    background-color: var(--color-background);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    color: var(--color-text);
    margin: 0;
}

.container.owner-calendar-page {
    max-width: 960px;
    margin: 32px auto;
    padding: 0 16px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 24px;
}

.header h1 {
    font-size: 1.8rem;
    color: var(--color-text);
    margin: 0;
}

.card {
    background: var(--color-surface);
    padding: 24px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    margin-bottom: 24px;
}

.card h2 {
    font-size: 1.3rem;
    margin: 0 0 20px 0;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-primary);
}

/* フォームのスタイル */
.reserve-form .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 6px;
    font-size: 0.9rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 1rem;
    background-color: #FDFDFD;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(142, 124, 195, 0.2);
}

.form-submit {
    text-align: right;
    margin-top: 20px;
}

/* ボタンのスタイル */
.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    text-align: center;
    display: inline-block;
}

.btn-primary {
    background-color: var(--color-primary);
    color: white;
}
.btn-primary:hover {
    background-color: var(--color-primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background-color: #f1f1f1;
    color: #555;
    border: 1px solid var(--color-border);
}
.btn-secondary:hover {
    background-color: #e9e9e9;
}

.btn-danger {
    background-color: var(--color-danger);
    color: white;
}
.btn-danger:hover {
    background-color: var(--color-danger-dark);
}
.btn-sm {
    padding: 5px 10px;
    font-size: 0.85em;
    font-weight: 500;
}

/* --- デスクトップ用カレンダー --- */
.desktop-calendar { display: block; }
.mobile-calendar { display: none; }

.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid var(--color-border);
    vertical-align: middle;
}
th.day-header, td.time-header {
    background-color: #F8F9FA;
    font-weight: 500;
    white-space: nowrap;
}
th.day-header .day-of-week { font-size: 1rem; }
th.day-header .date { font-size: 0.8rem; color: var(--color-text-light); }
td.time-header { min-width: 80px; }

.calendar-cell { height: 70px; }

.reserved-slot {
    background-color: #fde2e2;
    border-radius: 6px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    height: 100%;
    box-sizing: border-box;
}
.customer-name {
    font-weight: 600;
    font-size: 0.9em;
    color: #c0392b;
}
.available-text {
    color: var(--color-text-light);
    font-size: 0.9em;
}

/* --- モバイル用カレンダー --- */
.date-selector {
    display: flex;
    justify-content: space-around;
    gap: 6px;
    margin-bottom: 20px;
}
.date-chip {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-grow: 1;
    padding: 8px 4px;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.date-chip:hover {
    background-color: #f7f5fb;
}
.date-chip.active {
    background-color: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}
.date-chip .chip-day { font-size: 0.75rem; }
.date-chip .chip-date { font-size: 1rem; font-weight: 500; margin-top: 2px; }
.date-chip.active .chip-day,
.date-chip.active .chip-date {
    color: white;
}
.calendar-day-panel { display: none; }
.calendar-day-panel.active { display: block; }

.slot-list { list-style: none; padding: 0; margin: 0; }
.slot-item {
    display: flex;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid var(--color-border);
}
.slot-item:last-child { border-bottom: none; }
.slot-time { font-weight: 500; width: 70px; }
.slot-status { flex-grow: 1; }
.reserved-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding-left: 10px;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header h1 { font-size: 1.6rem; }
    
    .desktop-calendar { display: none; }
    .mobile-calendar { display: block; }
}

@media (max-width: 480px) {
    .container.owner-calendar-page { margin-top: 16px; padding: 0 8px;}
    .card { padding: 16px; }
    .header { align-items: center; }
    .header .back-link { width: 100%; }
    .back-link .btn { width: 100%; }

    .reserve-form .form-grid { grid-template-columns: 1fr; }
    .form-submit { text-align: center; }
    .form-submit .btn { width: 100%; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- モバイル用 日付チップ切り替え処理 ---
    const dateChips = document.querySelectorAll('.date-chip');
    const panels = document.querySelectorAll('.calendar-day-panel');

    dateChips.forEach(chip => {
        chip.addEventListener('click', () => {
            const dayIndex = chip.getAttribute('data-day-index');

            // すべてのアクティブ状態を解除
            dateChips.forEach(c => c.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));

            // クリックされたチップと対応するパネルをアクティブにする
            chip.classList.add('active');
            const activePanel = document.querySelector(`.calendar-day-panel[data-day-index="${dayIndex}"]`);
            if (activePanel) {
                activePanel.classList.add('active');
            }
        });
    });
});
</script><style>
:root {
    --color-primary: #8E7CC3;
    --color-primary-dark: #7A69A9;
    --color-danger: #FF6B6B;
    --color-danger-dark: #E65A5A;
    --color-background: #F8F9FA;
    --color-surface: #FFFFFF;
    --color-border: #E0E0E0;
    --color-text: #333333;
    --color-text-light: #757575;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --border-radius: 12px;
}

body {
    background-color: var(--color-background);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    color: var(--color-text);
    margin: 0;
}

.container.owner-calendar-page {
    max-width: 960px;
    margin: 32px auto;
    padding: 0 16px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 24px;
}

.header h1 {
    font-size: 1.8rem;
    color: var(--color-text);
    margin: 0;
}

.card {
    background: var(--color-surface);
    padding: 24px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    margin-bottom: 24px;
}

.card h2 {
    font-size: 1.3rem;
    margin: 0 0 20px 0;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-primary);
}

/* フォームのスタイル (変更なし) */
.reserve-form .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}
.form-group { display: flex; flex-direction: column; }
.form-group.full-width { grid-column: 1 / -1; }
.form-group label { font-weight: 500; margin-bottom: 6px; font-size: 0.9rem; }
.form-group input, .form-group select {
    width: 100%; padding: 10px 12px; border: 1px solid var(--color-border);
    border-radius: 8px; font-size: 1rem; background-color: #FDFDFD;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.form-group input:focus, .form-group select:focus {
    outline: none; border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(142, 124, 195, 0.2);
}
.form-submit { text-align: right; margin-top: 20px; }

/* ボタンのスタイル (変更なし) */
.btn {
    padding: 10px 20px; border-radius: 8px; font-weight: 600; text-decoration: none;
    transition: all 0.3s ease; border: none; cursor: pointer; text-align: center; display: inline-block;
}
.btn-primary { background-color: var(--color-primary); color: white; }
.btn-primary:hover { background-color: var(--color-primary-dark); transform: translateY(-2px); }
.btn-secondary { background-color: #f1f1f1; color: #555; border: 1px solid var(--color-border); }
.btn-secondary:hover { background-color: #e9e9e9; }
.btn-danger { background-color: var(--color-danger); color: white; }
.btn-danger:hover { background-color: var(--color-danger-dark); }
.btn-sm { padding: 5px 10px; font-size: 0.85em; font-weight: 500; }

/* --- カレンダーのスタイル --- */
/* 変更点①：モバイル用のカレンダーは常に非表示にする */
.mobile-calendar { display: none; }

.table-container {
    /* 変更点②：横方向のスクロールを有効にする */
    overflow-x: auto;
    /* iOSでのスクロールを滑らかにするおまじない */
    -webkit-overflow-scrolling: touch;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid var(--color-border);
    vertical-align: middle;
    /* 変更点③：列が潰れないように最小幅を指定 */
    min-width: 85px; /* iPhone SEなどでも4日弱表示できる幅 */
}
th.day-header, td.time-header {
    background-color: #F8F9FA;
    font-weight: 500;
    white-space: nowrap;
}
th.day-header .day-of-week { font-size: 1rem; }
th.day-header .date { font-size: 0.8rem; color: var(--color-text-light); }
td.time-header { min-width: 70px; /* 時間部分は少し狭くてもOK */ }

.calendar-cell { height: 70px; }

.reserved-slot {
    background-color: #fde2e2; border-radius: 6px; padding: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 5px; height: 100%; box-sizing: border-box;
}
.customer-name { font-weight: 600; font-size: 0.9em; color: #c0392b; }
.available-text { color: var(--color-text-light); font-size: 0.9em; }

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header h1 { font-size: 1.6rem; }
    
    /* 変更点④：モバイル用の表示切り替え指定を削除したため、ここにはもう何もいりません */
}

@media (max-width: 480px) {
    .container.owner-calendar-page { margin-top: 16px; padding: 0 8px; }
    .card { padding: 16px; }
    .header { align-items: center; }
    .header .back-link { width: 100%; }
    .back-link .btn { width: 100%; }

    .reserve-form .form-grid { grid-template-columns: 1fr; }
    .form-submit { text-align: center; }
    .form-submit .btn { width: 100%; }
    
    /* 変更点⑤：スマホでのセルの幅を少し調整 */
    th, td { min-width: 80px; }
    td.time-header { min-width: 60px; }
}
</style>
{% endblock %}